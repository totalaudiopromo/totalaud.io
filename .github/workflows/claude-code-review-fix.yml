# Claude Code Auto-Fix for CodeRabbit
# Fully automatic — no manual tagging required
#
# How it works:
# 1. You push a PR
# 2. CodeRabbit reviews and posts comments
# 3. If CodeRabbit requests changes → Claude auto-fixes and commits
# 4. If CodeRabbit posts inline suggestions → Claude applies them automatically
# 5. You just review Claude's fixes and merge

name: Claude Auto-Fix CodeRabbit

on:
  # Trigger on CodeRabbit inline comments
  pull_request_review_comment:
    types: [created]

  # Trigger on CodeRabbit review submissions
  pull_request_review:
    types: [submitted]

  # Trigger on CodeRabbit PR comments (summaries, etc.)
  issue_comment:
    types: [created]

# Ensure only one Claude run per PR at a time
concurrency:
  group: claude-fix-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  auto-fix-coderabbit:
    name: Auto-fix CodeRabbit feedback

    # Only run on CodeRabbit comments — fully automatic
    if: |
      github.event.comment.user.login == 'coderabbitai' ||
      github.event.review.user.login == 'coderabbitai' ||
      github.event.comment.user.login == 'coderabbitai[bot]' ||
      github.event.review.user.login == 'coderabbitai[bot]'

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Get PR details for issue_comment events
        id: pr_details
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_sha', pr.head.sha);
            return pr.head.ref;

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || steps.pr_details.outputs.head_ref || github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Extract review context
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            const event = context.eventName;
            let reviewBody = '';
            let filePath = '';
            let lineNumber = '';
            let isInlineSuggestion = false;
            let suggestionCode = '';

            if (event === 'pull_request_review_comment') {
              reviewBody = context.payload.comment.body || '';
              filePath = context.payload.comment.path || '';
              lineNumber = context.payload.comment.line || context.payload.comment.original_line || '';

              // Check for GitHub suggestion block
              const suggestionMatch = reviewBody.match(/```suggestion\n([\s\S]*?)```/);
              if (suggestionMatch) {
                isInlineSuggestion = true;
                suggestionCode = suggestionMatch[1];
              }
            } else if (event === 'pull_request_review') {
              reviewBody = context.payload.review.body || '';
            } else if (event === 'issue_comment') {
              reviewBody = context.payload.comment.body || '';
            }

            // Skip if it's just a summary or approval
            const isActionable = reviewBody.includes('suggestion') ||
                                 reviewBody.includes('consider') ||
                                 reviewBody.includes('should') ||
                                 reviewBody.includes('could') ||
                                 reviewBody.includes('fix') ||
                                 reviewBody.includes('change') ||
                                 reviewBody.includes('update') ||
                                 reviewBody.includes('replace') ||
                                 reviewBody.includes('remove') ||
                                 reviewBody.includes('add') ||
                                 reviewBody.includes('missing') ||
                                 reviewBody.includes('error') ||
                                 reviewBody.includes('warning') ||
                                 reviewBody.includes('issue') ||
                                 isInlineSuggestion;

            core.setOutput('review_body', reviewBody);
            core.setOutput('file_path', filePath);
            core.setOutput('line_number', lineNumber);
            core.setOutput('has_file_context', filePath ? 'true' : 'false');
            core.setOutput('is_inline_suggestion', isInlineSuggestion);
            core.setOutput('suggestion_code', suggestionCode);
            core.setOutput('is_actionable', isActionable);

            return { reviewBody, filePath, lineNumber, isInlineSuggestion, suggestionCode, isActionable };

      - name: Skip non-actionable comments
        if: steps.context.outputs.is_actionable != 'true'
        run: |
          echo "Skipping non-actionable CodeRabbit comment (likely a summary or approval)"
          exit 0

      - name: Run Claude Code to apply fixes
        if: steps.context.outputs.is_actionable == 'true'
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          prompt: |
            You are automatically fixing a CodeRabbit review comment. Apply the fix directly without asking questions.

            ## Project Context
            - Project: totalaud.io (Next.js 15, TypeScript, Tailwind, Framer Motion, Supabase)
            - Use British English spelling in all code and comments
            - Use Framer Motion for animations (NOT CSS transitions)
            - Use @/lib/logger instead of console.log
            - Use @/lib/api-validation for API input validation

            ## CodeRabbit Feedback
            ${{ steps.context.outputs.review_body }}
            ${{ steps.context.outputs.has_file_context == 'true' && format('

            ## File Location
            Path: {0}
            Line: {1}', steps.context.outputs.file_path, steps.context.outputs.line_number) || '' }}
            ${{ steps.context.outputs.is_inline_suggestion == 'true' && format('

            ## Inline Suggestion
            Apply this exact code:
            ```
            {0}
            ```', steps.context.outputs.suggestion_code) || '' }}

            ## Instructions
            1. If this is an inline suggestion with code, apply it exactly as suggested
            2. If this is a general comment, analyse and implement the fix
            3. After making changes, run: pnpm lint:fix && pnpm format
            4. Verify with: pnpm turbo typecheck --filter=aud-web
            5. Stage and commit your changes with a clear message like:
               "fix: apply CodeRabbit suggestion - [brief description]"
            6. Push the commit

            Apply the fix now. Do not ask for confirmation.

          allowed_tools: |
            Edit
            Write
            Read
            Glob
            Grep
            Bash(pnpm lint:fix)
            Bash(pnpm format)
            Bash(pnpm turbo typecheck --filter=aud-web)
            Bash(git status)
            Bash(git add)
            Bash(git commit)
            Bash(git push)

          model: claude-sonnet-4-20250514
          max_turns: 15
          timeout_minutes: 10

      - name: Post fix confirmation
        if: steps.context.outputs.is_actionable == 'true' && success()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || context.payload.issue?.number;
            if (!prNumber) return;

            // Reply to the specific comment if it's an inline comment
            const commentId = context.payload.comment?.id;

            if (commentId && context.eventName === 'pull_request_review_comment') {
              await github.rest.pulls.createReplyForReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                comment_id: commentId,
                body: '✅ Fixed automatically by Claude'
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: '✅ Claude has automatically applied the CodeRabbit suggestion and pushed a fix.'
              });
            }

      - name: Post failure notice
        if: steps.context.outputs.is_actionable == 'true' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || context.payload.issue?.number;
            if (!prNumber) return;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: '⚠️ Claude attempted to fix the CodeRabbit feedback but encountered an issue. Manual review may be needed.'
            });

  # Separate job for manual @claude requests (optional, for non-CodeRabbit comments)
  manual-claude-fix:
    name: Manual Claude fix request

    if: |
      github.event.comment.user.login != 'coderabbitai' &&
      github.event.review.user.login != 'coderabbitai' &&
      github.event.comment.user.login != 'coderabbitai[bot]' &&
      github.event.review.user.login != 'coderabbitai[bot]' &&
      (contains(github.event.comment.body, '@claude') || contains(github.event.comment.body, 'claude fix'))

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.head_ref }}
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Claude Code for manual request
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          prompt: |
            A team member has requested your help with this comment:

            ${{ github.event.comment.body }}

            File: ${{ github.event.comment.path }}
            Line: ${{ github.event.comment.line }}

            Project: totalaud.io (Next.js 15, TypeScript, Tailwind, Framer Motion)
            Use British English spelling.

            Analyse the request and implement the fix. Run lint and typecheck after.
            Commit and push your changes.

          allowed_tools: |
            Edit
            Write
            Read
            Glob
            Grep
            Bash(pnpm lint:fix)
            Bash(pnpm format)
            Bash(pnpm turbo typecheck --filter=aud-web)
            Bash(git status)
            Bash(git add)
            Bash(git commit)
            Bash(git push)

          model: claude-sonnet-4-20250514
          max_turns: 15
          timeout_minutes: 10

      - name: Post fix confirmation
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || context.payload.issue?.number;
            if (!prNumber) return;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: '✅ Claude has addressed the manual fix request.'
            });

      - name: Post failure notice
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || context.payload.issue?.number;
            if (!prNumber) return;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: '⚠️ Claude attempted to address the manual fix request but encountered an issue.'
            });
