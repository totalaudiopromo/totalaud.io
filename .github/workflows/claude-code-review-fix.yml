# Claude PR Fix
# Trigger with @claude or "claude fix" in any PR comment
#
# How it works:
# 1. A reviewer posts a comment containing @claude or "claude fix"
# 2. Claude analyses the request and implements the fix
# 3. Changes are linted, typechecked, committed, and pushed
# 4. You review Claude's fixes and merge

name: Claude PR Fix

on:
  # Trigger on PR inline review comments
  pull_request_review_comment:
    types: [created]

  # Trigger on general PR comments
  issue_comment:
    types: [created]

# Ensure only one Claude run per PR at a time
concurrency:
  group: claude-fix-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  claude-fix:
    name: Claude fix request

    if: |
      contains(github.event.comment.body, '@claude') ||
      contains(github.event.comment.body, 'claude fix')

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Get PR details for issue_comment events
        id: pr_details
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_sha', pr.head.sha);
            return pr.head.ref;

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || steps.pr_details.outputs.head_ref || github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Claude Code
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          prompt: |
            A team member has requested your help with this comment:

            ${{ github.event.comment.body }}

            File: ${{ github.event.comment.path }}
            Line: ${{ github.event.comment.line }}

            Project: totalaud.io (Next.js 15, TypeScript, Tailwind, Framer Motion)
            Use British English spelling.

            Analyse the request and implement the fix. Run lint and typecheck after.
            Commit and push your changes.

          allowed_tools: |
            Edit
            Write
            Read
            Glob
            Grep
            Bash(pnpm lint:fix)
            Bash(pnpm format)
            Bash(pnpm turbo typecheck --filter=aud-web)
            Bash(git status)
            Bash(git add)
            Bash(git commit)
            Bash(git push)

          model: claude-sonnet-4-20250514
          max_turns: 15
          timeout_minutes: 10

      - name: Post fix confirmation
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || context.payload.issue?.number;
            if (!prNumber) return;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: '✅ Claude has addressed the fix request.'
            });

      - name: Post failure notice
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || context.payload.issue?.number;
            if (!prNumber) return;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: '⚠️ Claude attempted to address the fix request but encountered an issue.'
            });
